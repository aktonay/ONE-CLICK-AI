#!/usr/bin/env python3
"""
ðŸš€ {{ project_name }} â€” Cross-Platform Deploy Script
Generated by one-click-ai (ocd-ai)

Works on: Windows, macOS, Linux
Usage:
    python deploy.py                    # Interactive deploy wizard
    python deploy.py push               # Git push only
    python deploy.py build              # Docker build & push
    python deploy.py railway            # Deploy to Railway
    python deploy.py --platform aws     # Deploy to AWS
"""

import os
import sys
import subprocess
import shutil
import json
from datetime import datetime
from pathlib import Path

# â”€â”€ Config â”€â”€
PROJECT = "{{ project_name }}"
GITHUB_URL = "{{ github_repository_url | default('', true) }}"
GITHUB_USER = "{{ github_username | default('', true) }}"
DOCKERHUB_USER = "{{ dockerhub_username | default('', true) }}"
IMAGE_NAME = f"{DOCKERHUB_USER or GITHUB_USER or 'user'}/{PROJECT}"

# â”€â”€ Colors (cross-platform) â”€â”€
if sys.platform == "win32":
    os.system("color")  # Enable ANSI on Windows

RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
BLUE = "\033[94m"
CYAN = "\033[96m"
BOLD = "\033[1m"
NC = "\033[0m"


def info(msg: str):
    print(f"{BLUE}â„¹ {NC}{msg}")

def success(msg: str):
    print(f"{GREEN}âœ… {msg}{NC}")

def warn(msg: str):
    print(f"{YELLOW}âš  {msg}{NC}")

def error(msg: str):
    print(f"{RED}âŒ {msg}{NC}")
    sys.exit(1)

def run(cmd: str | list, check: bool = True, capture: bool = False, **kwargs):
    """Run a command, print it, and return result."""
    if isinstance(cmd, str):
        print(f"  {CYAN}$ {cmd}{NC}")
        result = subprocess.run(cmd, shell=True, capture_output=capture, text=True, **kwargs)
    else:
        print(f"  {CYAN}$ {' '.join(cmd)}{NC}")
        result = subprocess.run(cmd, capture_output=capture, text=True, **kwargs)
    if check and result.returncode != 0:
        if capture and result.stderr:
            warn(result.stderr.strip())
    return result

def has_command(cmd: str) -> bool:
    return shutil.which(cmd) is not None

def banner():
    print(f"""
{CYAN}{BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ðŸš€ {PROJECT} â€” Deploy Wizard
â•‘   Generated by one-click-ai
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{NC}
""")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def git_push(message: str = ""):
    """Stage all, commit, push to GitHub."""
    info("Pushing code to GitHub...")
    if not has_command("git"):
        error("git is not installed")

    if not Path(".git").exists():
        run("git init")
        run("git branch -M main")

    # Set remote
    result = run("git remote get-url origin", check=False, capture=True)
    if result.returncode != 0:
        remote = GITHUB_URL or input("Enter GitHub repository URL: ").strip()
        if remote:
            # Convert HTTPS to SSH
            if "https://github.com/" in remote:
                repo_path = remote.replace("https://github.com/", "").rstrip("/").rstrip(".git")
                remote = f"git@github.com:{repo_path}.git"
            run(f"git remote add origin {remote}")

    run("git add -A")
    msg = message or f"deploy: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    run(f'git commit -m "{msg}"', check=False)
    run("git push -u origin main")
    success("Code pushed to GitHub!")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DOCKER BUILD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def docker_build(tag: str = "latest"):
    """Build and push Docker image."""
    info("Building Docker image...")
    if not has_command("docker"):
        error("docker is not installed")

    run(f"docker build -t {IMAGE_NAME}:{tag} -f backend/Dockerfile backend/")
    run(f"docker tag {IMAGE_NAME}:{tag} {IMAGE_NAME}:latest")

    info("Pushing Docker image...")
    result = run(f"docker push {IMAGE_NAME}:{tag}", check=False, capture=True)
    if result.returncode != 0:
        ghcr = f"ghcr.io/{GITHUB_USER}/{PROJECT}"
        warn("DockerHub push failed. Trying GitHub Container Registry...")
        run(f"docker tag {IMAGE_NAME}:{tag} {ghcr}:{tag}")
        run(f"docker push {ghcr}:{tag}")

    success(f"Docker image pushed: {IMAGE_NAME}:{tag}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PLATFORMS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def deploy_aws():
    """Deploy to AWS App Runner (simplest)."""
    info("Deploying to AWS App Runner...")
    if not has_command("aws"):
        error("AWS CLI is not installed. Run: pip install awscli")

    region = os.environ.get("AWS_REGION", "us-east-1")

    # Create ECR repo
    run(f"aws ecr describe-repositories --repository-names {PROJECT} --region {region}", check=False, capture=True)
    result = run(f"aws ecr describe-repositories --repository-names {PROJECT} --region {region}", check=False, capture=True)
    if result.returncode != 0:
        run(f"aws ecr create-repository --repository-name {PROJECT} --region {region}")

    # Get ECR URI
    result = run(
        f"aws ecr describe-repositories --repository-names {PROJECT} --region {region} "
        f"--query repositories[0].repositoryUri --output text",
        capture=True,
    )
    ecr_uri = result.stdout.strip()

    # Login, build, push
    run(f"aws ecr get-login-password --region {region} | docker login --username AWS --password-stdin {ecr_uri.split('/')[0]}")
    run(f"docker build -t {ecr_uri}:latest -f backend/Dockerfile backend/")
    run(f"docker push {ecr_uri}:latest")

    success(f"Image pushed to ECR: {ecr_uri}")
    info("Now create/update your ECS service or App Runner service in the AWS Console.")


def deploy_azure():
    """Deploy to Azure Container Apps."""
    info("Deploying to Azure Container Apps...")
    if not has_command("az"):
        error("Azure CLI is not installed. Run: pip install azure-cli")

    rg = f"{PROJECT}-rg"
    location = os.environ.get("AZURE_LOCATION", "eastus")
    acr = PROJECT.replace("-", "").replace("_", "") + "acr"

    run(f"az group create --name {rg} --location {location} -o none", check=False)
    run(f"az acr create --resource-group {rg} --name {acr} --sku Basic -o none", check=False)
    run(f"az acr login --name {acr}")

    acr_server = f"{acr}.azurecr.io"
    run(f"docker build -t {acr_server}/{PROJECT}:latest -f backend/Dockerfile backend/")
    run(f"docker push {acr_server}/{PROJECT}:latest")

    run(f"az containerapp env create --name {PROJECT}-env --resource-group {rg} --location {location} -o none", check=False)
    run(f"az acr update -n {acr} --admin-enabled true -o none")

    result = run(f"az acr credential show -n {acr} --query passwords[0].value -o tsv", capture=True)
    acr_pass = result.stdout.strip()

    run(
        f"az containerapp create --name {PROJECT} --resource-group {rg} "
        f"--environment {PROJECT}-env --image {acr_server}/{PROJECT}:latest "
        f"--target-port 8000 --ingress external "
        f"--registry-server {acr_server} --registry-username {acr} --registry-password {acr_pass} "
        f"--cpu 0.5 --memory 1.0Gi -o none",
        check=False,
    )
    result = run(
        f"az containerapp show --name {PROJECT} --resource-group {rg} "
        f"--query properties.configuration.ingress.fqdn -o tsv",
        capture=True,
    )
    success(f"Deployed to Azure: https://{result.stdout.strip()}")


def deploy_gcp():
    """Deploy to GCP Cloud Run."""
    info("Deploying to GCP Cloud Run...")
    if not has_command("gcloud"):
        error("gcloud CLI is not installed")

    result = run("gcloud config get-value project", capture=True)
    gcp_project = os.environ.get("GCP_PROJECT_ID", result.stdout.strip())
    region = os.environ.get("GCP_REGION", "us-central1")

    run(f"gcloud services enable run.googleapis.com --project={gcp_project}")
    run(f"gcloud auth configure-docker {region}-docker.pkg.dev --quiet")

    image = f"{region}-docker.pkg.dev/{gcp_project}/{PROJECT}/{PROJECT}:latest"
    run(f"gcloud artifacts repositories create {PROJECT} --repository-format=docker --location={region} --project={gcp_project}", check=False)
    run(f"docker build -t {image} -f backend/Dockerfile backend/")
    run(f"docker push {image}")

    run(
        f"gcloud run deploy {PROJECT} --image {image} --platform managed "
        f"--region {region} --port 8000 --allow-unauthenticated "
        f"--memory 1Gi --cpu 1 --project {gcp_project}"
    )
    result = run(f"gcloud run services describe {PROJECT} --region {region} --project {gcp_project} --format=value(status.url)", capture=True)
    success(f"Deployed to GCP: {result.stdout.strip()}")


def deploy_digitalocean():
    """Deploy to DigitalOcean App Platform."""
    info("Deploying to DigitalOcean App Platform...")
    if not has_command("doctl"):
        error("doctl CLI is not installed. See: https://docs.digitalocean.com/reference/doctl/how-to/install/")

    spec = {
        "name": PROJECT,
        "services": [{
            "name": PROJECT,
            "dockerfile_path": "backend/Dockerfile",
            "github": {
                "repo": f"{GITHUB_USER}/{PROJECT}",
                "branch": "main",
                "deploy_on_push": True,
            },
            "http_port": 8000,
            "instance_count": 1,
            "instance_size_slug": "basic-xxs",
            "routes": [{"path": "/"}],
        }],
    }

    spec_path = Path("/tmp/do-app-spec.json") if sys.platform != "win32" else Path(os.environ["TEMP"]) / "do-app-spec.json"
    spec_path.write_text(json.dumps(spec, indent=2))

    run(f"doctl apps create --spec {spec_path}")
    success("Deployed to DigitalOcean App Platform!")


def deploy_railway():
    """Deploy to Railway (easiest)."""
    info("Deploying to Railway...")
    if not has_command("railway"):
        error("Railway CLI is not installed. Run: npm install -g @railway/cli")

    run("railway login", check=False)
    run("railway init", check=False)
    run("railway up --detach")
    run("railway open", check=False)
    success("Deployed to Railway!")


def deploy_fly():
    """Deploy to Fly.io."""
    info("Deploying to Fly.io...")
    if not has_command("flyctl"):
        error("flyctl is not installed. See: https://fly.io/docs/flyctl/install/")

    if not Path("fly.toml").exists():
        run(f"flyctl launch --name {PROJECT} --dockerfile backend/Dockerfile --internal-port 8000 --region iad --no-deploy --yes")

    run("flyctl deploy")
    success("Deployed to Fly.io!")


def deploy_render():
    """Deploy to Render (via git push)."""
    info("Deploying to Render...")
    if not Path("render.yaml").exists():
        Path("render.yaml").write_text(f"""services:
  - type: web
    name: {PROJECT}
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    envVars:
      - key: PORT
        value: 8000
""")
        success("Created render.yaml")

    warn("Render deploys via git push. Ensure repo is connected at https://render.com")
    git_push(f"deploy: render {datetime.now().strftime('%Y-%m-%d')}")


def deploy_self_hosted():
    """Deploy to your own server."""
    host = input("Server IP/hostname: ").strip()
    user = input("SSH user [root]: ").strip() or "root"

    info(f"Deploying to {user}@{host}...")
    remote_url = GITHUB_URL or f"https://github.com/{GITHUB_USER}/{PROJECT}.git"

    script = f"""
set -e
if ! command -v docker &>/dev/null; then curl -fsSL https://get.docker.com | sh; fi
mkdir -p /opt/{PROJECT} && cd /opt/{PROJECT}
git clone {remote_url} . 2>/dev/null || git pull origin main
docker compose -f docker-compose.prod.yml up -d --build
sleep 5 && curl -sf http://localhost:8000/api/v1/health || echo "Starting up..."
"""
    run(f'ssh -o StrictHostKeyChecking=no {user}@{host} "{script}"')
    success(f"Deployed to {host}!")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WIZARD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PLATFORMS = {
    "1": ("AWS", deploy_aws),
    "2": ("Azure", deploy_azure),
    "3": ("DigitalOcean", deploy_digitalocean),
    "4": ("GCP Cloud Run", deploy_gcp),
    "5": ("Railway", deploy_railway),
    "6": ("Fly.io", deploy_fly),
    "7": ("Render", deploy_render),
    "8": ("Self-hosted", deploy_self_hosted),
}


def deploy_wizard():
    """Interactive deploy wizard."""
    banner()

    print(f"{BOLD}Choose deployment platform:{NC}")
    print()
    for key, (name, _) in PLATFORMS.items():
        rec = " (recommended for quick start)" if key == "5" else ""
        print(f"  {GREEN}{key}){NC} {name}{rec}")
    print()

    choice = input("Select platform [1-8]: ").strip()
    if choice not in PLATFORMS:
        error("Invalid choice")

    platform_name, deploy_fn = PLATFORMS[choice]
    print()

    # Step 1: Push
    info("Step 1/3: Pushing code to GitHub...")
    git_push()
    print()

    # Step 2: Build
    info("Step 2/3: Building Docker image...")
    try:
        result = run("git rev-parse --short HEAD", capture=True, check=False)
        tag = result.stdout.strip() if result.returncode == 0 else "latest"
    except Exception:
        tag = "latest"
    docker_build(tag)
    print()

    # Step 3: Deploy
    info(f"Step 3/3: Deploying to {platform_name}...")
    deploy_fn()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLI ENTRY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def main():
    args = sys.argv[1:]
    cmd = args[0] if args else "deploy"

    commands = {
        "deploy": deploy_wizard,
        "push": lambda: git_push(args[1] if len(args) > 1 else ""),
        "build": lambda: docker_build(args[1] if len(args) > 1 else "latest"),
        "aws": deploy_aws,
        "azure": deploy_azure,
        "do": deploy_digitalocean,
        "gcp": deploy_gcp,
        "railway": deploy_railway,
        "fly": deploy_fly,
        "render": deploy_render,
        "server": deploy_self_hosted,
        "status": lambda: print(f"Local: http://localhost:8000/docs"),
    }

    if cmd in ("help", "--help", "-h"):
        banner()
        print(f"{BOLD}Usage:{NC} python deploy.py [command]")
        print()
        print(f"{BOLD}Commands:{NC}")
        for c in commands:
            print(f"  {c}")
        print()
        print(f"{BOLD}Quick deploy:{NC} python deploy.py")
        return

    if cmd in commands:
        commands[cmd]()
    elif cmd.startswith("--platform"):
        p = args[1] if len(args) > 1 else ""
        fn = {
            "aws": deploy_aws, "azure": deploy_azure, "gcp": deploy_gcp,
            "do": deploy_digitalocean, "railway": deploy_railway,
            "fly": deploy_fly, "render": deploy_render,
        }.get(p)
        if fn:
            fn()
        else:
            error(f"Unknown platform: {p}")
    else:
        error(f"Unknown command: {cmd}. Run: python deploy.py help")


if __name__ == "__main__":
    main()
