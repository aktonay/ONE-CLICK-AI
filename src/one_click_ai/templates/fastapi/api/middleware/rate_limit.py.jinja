"""Simple in-memory rate limiter middleware."""

from fastapi import Request
from fastapi.responses import JSONResponse
from collections import defaultdict
import time

# Simple sliding-window counter (replace with Redis in production)
_request_counts: dict[str, list[float]] = defaultdict(list)
RATE_LIMIT = 120  # requests per minute


async def rate_limit_middleware(request: Request, call_next):
    client_ip = request.client.host if request.client else "unknown"
    now = time.time()
    window = 60.0

    # Prune old entries
    _request_counts[client_ip] = [
        t for t in _request_counts[client_ip] if now - t < window
    ]

    if len(_request_counts[client_ip]) >= RATE_LIMIT:
        return JSONResponse(
            status_code=429,
            content={"detail": "Rate limit exceeded. Try again later."},
        )

    _request_counts[client_ip].append(now)
    return await call_next(request)
