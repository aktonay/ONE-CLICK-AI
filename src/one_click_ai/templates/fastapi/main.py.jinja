"""
{{ project_name }} â€” AI-Powered Application
Generated by: one-click-ai
"""

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.gzip import GZipMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.responses import JSONResponse
from contextlib import asynccontextmanager
import logging

from app.config import get_settings
from app.utils.logger import setup_logging

# â”€â”€ Routers â”€â”€
from app.api.v1.health import router as health_router
from app.api.v1.chat import router as chat_router
{% if rag %}
from app.api.v1.rag import router as rag_router
from app.api.v1.documents import router as documents_router
{% endif %}
{% if voice %}
from app.api.v1.voice import router as voice_router
{% endif %}
{% if voice_to_voice %}
from app.api.v1.websocket import router as ws_router
{% endif %}
{% if vision %}
from app.api.v1.vision import router as vision_router
{% endif %}
{% if emotion %}
from app.api.v1.emotion import router as emotion_router
{% endif %}
{% if search %}
from app.api.v1.search import router as search_router
{% endif %}
{% if agents %}
from app.api.v1.agents import router as agents_router
{% endif %}
{% if session %}
from app.api.v1.sessions import router as sessions_router
{% endif %}

# â”€â”€ Middleware â”€â”€
from app.api.middleware.error_handler import error_handler_middleware
from app.api.middleware.logging_mw import logging_middleware
{% if monitoring %}
from prometheus_client import make_asgi_app as prometheus_app
{% endif %}

setup_logging()
logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Startup / shutdown lifecycle."""
    logger.info("ðŸš€ Starting {{ project_name }} â€¦")
    settings = get_settings()

{% if rag %}
    # Initialise vector store
    from app.vector_stores.factory import VectorStoreFactory
    app.state.vector_store = VectorStoreFactory.create(settings.VECTOR_STORE_TYPE)
    logger.info("Vector store ready: %s", settings.VECTOR_STORE_TYPE)
{% endif %}
{% if redis %}
    import redis.asyncio as aioredis
    app.state.redis = aioredis.from_url(settings.REDIS_URL)
    logger.info("Redis connected")
{% endif %}

    yield

    logger.info("ðŸ›‘ Shutting down {{ project_name }} â€¦")
{% if redis %}
    await app.state.redis.close()
{% endif %}


settings = get_settings()

app = FastAPI(
    title="{{ project_name }} API",
    description="{{ project_description }}",
    version="{{ project_version }}",
    docs_url="/docs" if settings.DEBUG else None,
    redoc_url="/redoc" if settings.DEBUG else None,
    openapi_url="/openapi.json" if settings.DEBUG else None,
    lifespan=lifespan,
)

# â”€â”€ Middleware stack â”€â”€
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=settings.ALLOWED_HOSTS,
)
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    expose_headers=["X-Request-ID", "X-Process-Time"],
)
app.add_middleware(GZipMiddleware, minimum_size=1000)
app.middleware("http")(error_handler_middleware)
app.middleware("http")(logging_middleware)

{% if monitoring %}
# Mount Prometheus metrics
metrics_app = prometheus_app()
app.mount("/metrics", metrics_app)
{% endif %}

# â”€â”€ Routers â”€â”€
app.include_router(health_router, prefix="/health", tags=["Health"])
app.include_router(chat_router, prefix="/api/v1/chat", tags=["Chat"])
{% if rag %}
app.include_router(rag_router, prefix="/api/v1/rag", tags=["RAG"])
app.include_router(documents_router, prefix="/api/v1/documents", tags=["Documents"])
{% endif %}
{% if voice %}
app.include_router(voice_router, prefix="/api/v1/voice", tags=["Voice"])
{% endif %}
{% if voice_to_voice %}
app.include_router(ws_router, prefix="/api/v1/ws", tags=["WebSocket"])
{% endif %}
{% if vision %}
app.include_router(vision_router, prefix="/api/v1/vision", tags=["Vision"])
{% endif %}
{% if emotion %}
app.include_router(emotion_router, prefix="/api/v1/emotion", tags=["Emotion"])
{% endif %}
{% if search %}
app.include_router(search_router, prefix="/api/v1/search", tags=["Search"])
{% endif %}
{% if agents %}
app.include_router(agents_router, prefix="/api/v1/agents", tags=["Agents"])
{% endif %}
{% if session %}
app.include_router(sessions_router, prefix="/api/v1/sessions", tags=["Sessions"])
{% endif %}


@app.get("/", tags=["Root"])
async def root():
    return {
        "name": "{{ project_name }}",
        "version": "{{ project_version }}",
        "status": "operational",
        "docs": "/docs",
    }


@app.exception_handler(404)
async def not_found(request: Request, exc):
    return JSONResponse(status_code=404, content={"detail": "Not found"})


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "app.main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG,
        workers=1 if settings.DEBUG else settings.WORKERS,
    )
