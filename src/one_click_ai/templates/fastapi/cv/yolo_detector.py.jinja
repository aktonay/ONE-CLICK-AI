{# YOLO Detector #}
"""
YOLOv8/v11 object detection via Ultralytics.
"""

import logging
from typing import Any, Dict, List, Optional
from pathlib import Path

logger = logging.getLogger(__name__)


class YOLODetector:
    """YOLO object detection wrapper."""

    def __init__(self, model_name: str = "yolov8n.pt"):
        from ultralytics import YOLO
        self.model = YOLO(model_name)
        logger.info(f"YOLO model loaded: {model_name}")

    def detect(
        self,
        source: str,
        confidence: float = 0.5,
        iou_threshold: float = 0.45,
        classes: Optional[List[int]] = None,
    ) -> Dict[str, Any]:
        """Run detection on image/video/stream."""
        results = self.model(
            source,
            conf=confidence,
            iou=iou_threshold,
            classes=classes,
            verbose=False,
        )

        detections = []
        for r in results:
            for box in r.boxes:
                detections.append({
                    "label": self.model.names[int(box.cls)],
                    "confidence": float(box.conf),
                    "box": box.xyxy[0].tolist(),
                    "class_id": int(box.cls),
                })

        return {
            "detections": detections,
            "count": len(detections),
            "source": source,
        }

    def detect_video(self, video_path: str, output_path: str = "output.mp4", **kwargs) -> Dict[str, Any]:
        """Run detection on video."""
        results = self.model(video_path, save=True, project="runs/detect", **kwargs)
        return {"output": output_path, "frames_processed": len(results)}

    def train_custom(
        self,
        data_yaml: str,
        epochs: int = 100,
        imgsz: int = 640,
        batch: int = 16,
    ) -> Dict[str, Any]:
        """Train YOLO on custom dataset."""
        results = self.model.train(
            data=data_yaml,
            epochs=epochs,
            imgsz=imgsz,
            batch=batch,
            device="0",
        )
        return {"results": str(results)}

    def export(self, format: str = "onnx") -> str:
        """Export model to different format (onnx, tensorrt, etc.)."""
        path = self.model.export(format=format)
        logger.info(f"Model exported to {path}")
        return str(path)
