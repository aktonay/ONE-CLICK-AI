{# OCR Engine #}
"""
OCR â€” text extraction from images using Tesseract & EasyOCR.
"""

import logging
from typing import Any, Dict, List, Optional

logger = logging.getLogger(__name__)


class OCREngine:
    """Multi-backend OCR engine."""

    def __init__(self, backend: str = "easyocr", lang: str = "en"):
        self.backend = backend
        self.lang = lang
        self._reader = None

    def _init_reader(self):
        if self._reader is not None:
            return
        if self.backend == "easyocr":
            import easyocr
            self._reader = easyocr.Reader([self.lang])
        logger.info(f"OCR engine initialized: {self.backend}")

    def extract(self, image_path: str) -> Dict[str, Any]:
        """Extract text from image."""
        if self.backend == "tesseract":
            return self._tesseract_extract(image_path)
        return self._easyocr_extract(image_path)

    def _easyocr_extract(self, image_path: str) -> Dict[str, Any]:
        self._init_reader()
        results = self._reader.readtext(image_path)
        blocks = []
        full_text = []
        for bbox, text, conf in results:
            blocks.append({
                "text": text,
                "confidence": float(conf),
                "bbox": [[int(p) for p in point] for point in bbox],
            })
            full_text.append(text)
        return {
            "full_text": " ".join(full_text),
            "blocks": blocks,
            "block_count": len(blocks),
        }

    def _tesseract_extract(self, image_path: str) -> Dict[str, Any]:
        import pytesseract
        from PIL import Image
        image = Image.open(image_path)
        text = pytesseract.image_to_string(image, lang=self.lang)
        data = pytesseract.image_to_data(image, output_type=pytesseract.Output.DICT, lang=self.lang)
        blocks = []
        for i, word in enumerate(data["text"]):
            if word.strip():
                blocks.append({
                    "text": word,
                    "confidence": float(data["conf"][i]),
                    "bbox": [data["left"][i], data["top"][i],
                             data["left"][i] + data["width"][i],
                             data["top"][i] + data["height"][i]],
                })
        return {
            "full_text": text.strip(),
            "blocks": blocks,
            "block_count": len(blocks),
        }
