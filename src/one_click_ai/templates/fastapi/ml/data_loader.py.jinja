{# ML Data Loader #}
"""
Data loading and preprocessing utilities.
"""

import logging
from pathlib import Path
from typing import Any, Dict, List, Optional, Tuple

logger = logging.getLogger(__name__)


def load_csv(path: str, target_column: str = "target") -> Tuple[Any, Any]:
    """Load CSV data, split features and target."""
    import pandas as pd
    df = pd.read_csv(path)
    X = df.drop(columns=[target_column])
    y = df[target_column]
    logger.info(f"Loaded {len(df)} rows from {path}")
    return X, y


def train_test_val_split(
    X, y, test_size: float = 0.2, val_size: float = 0.1, random_state: int = 42
):
    """Split data into train, validation, and test sets."""
    from sklearn.model_selection import train_test_split
    X_temp, X_test, y_temp, y_test = train_test_split(X, y, test_size=test_size, random_state=random_state)
    val_ratio = val_size / (1 - test_size)
    X_train, X_val, y_train, y_val = train_test_split(X_temp, y_temp, test_size=val_ratio, random_state=random_state)
    logger.info(f"Split: train={len(X_train)}, val={len(X_val)}, test={len(X_test)}")
    return X_train, X_val, X_test, y_train, y_val, y_test


{% if pytorch %}
def create_pytorch_dataloaders(X_train, y_train, X_val, y_val, batch_size: int = 32):
    """Create PyTorch DataLoaders from numpy/pandas data."""
    import torch
    from torch.utils.data import DataLoader, TensorDataset
    import numpy as np

    def to_tensor(data):
        if hasattr(data, "values"):
            data = data.values
        return torch.tensor(np.array(data), dtype=torch.float32)

    train_ds = TensorDataset(to_tensor(X_train), torch.tensor(np.array(y_train), dtype=torch.long))
    val_ds = TensorDataset(to_tensor(X_val), torch.tensor(np.array(y_val), dtype=torch.long))

    train_loader = DataLoader(train_ds, batch_size=batch_size, shuffle=True, num_workers=0)
    val_loader = DataLoader(val_ds, batch_size=batch_size, shuffle=False, num_workers=0)
    return train_loader, val_loader
{% endif %}
