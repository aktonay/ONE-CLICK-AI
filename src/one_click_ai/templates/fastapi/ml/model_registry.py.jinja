{# Model Registry #}
"""
Model versioning and registry â€” track, compare, and deploy models.
"""

import json
import logging
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional

logger = logging.getLogger(__name__)

REGISTRY_PATH = Path("models/registry.json")


class ModelRegistry:
    """Simple file-based model registry."""

    def __init__(self, registry_path: Path = REGISTRY_PATH):
        self.path = registry_path
        self.path.parent.mkdir(parents=True, exist_ok=True)
        self.entries: List[Dict[str, Any]] = self._load()

    def _load(self) -> List[Dict[str, Any]]:
        if self.path.exists():
            return json.loads(self.path.read_text())
        return []

    def _save(self):
        self.path.write_text(json.dumps(self.entries, indent=2, default=str))

    def register(
        self,
        name: str,
        version: str,
        model_path: str,
        framework: str,
        metrics: Dict[str, float],
        params: Dict[str, Any] = None,
        tags: List[str] = None,
    ) -> Dict[str, Any]:
        """Register a new model version."""
        entry = {
            "name": name,
            "version": version,
            "model_path": model_path,
            "framework": framework,
            "metrics": metrics,
            "params": params or {},
            "tags": tags or [],
            "registered_at": datetime.utcnow().isoformat(),
            "status": "registered",
        }
        self.entries.append(entry)
        self._save()
        logger.info(f"Registered model: {name} v{version}")
        return entry

    def get_best(self, name: str, metric: str = "accuracy") -> Optional[Dict[str, Any]]:
        """Get best model version by metric."""
        candidates = [e for e in self.entries if e["name"] == name and e["status"] != "archived"]
        if not candidates:
            return None
        return max(candidates, key=lambda e: e["metrics"].get(metric, 0))

    def list_models(self, name: Optional[str] = None) -> List[Dict[str, Any]]:
        """List all registered models."""
        if name:
            return [e for e in self.entries if e["name"] == name]
        return self.entries

    def promote(self, name: str, version: str):
        """Promote a model to 'production' status."""
        for entry in self.entries:
            if entry["name"] == name:
                if entry["version"] == version:
                    entry["status"] = "production"
                elif entry["status"] == "production":
                    entry["status"] = "archived"
        self._save()
        logger.info(f"Promoted {name} v{version} to production")
