"""Result reranking using cross-encoder models."""

from typing import List
from app.core.rag.chunking import Chunk
import logging

logger = logging.getLogger(__name__)


class Reranker:
    def __init__(self, model_name: str = "cross-encoder/ms-marco-MiniLM-L-12-v2"):
        self.model_name = model_name
        self._model = None

    def _load_model(self):
        if self._model is None:
            try:
                from sentence_transformers import CrossEncoder
                self._model = CrossEncoder(self.model_name)
            except ImportError:
                logger.warning("sentence-transformers not installed â€” reranking disabled")
                return None
        return self._model

    async def rerank(
        self, query: str, chunks: List[Chunk], top_k: int = 5
    ) -> List[Chunk]:
        """Rerank chunks by relevance to the query."""
        model = self._load_model()
        if model is None:
            return chunks[:top_k]

        pairs = [(query, chunk.text) for chunk in chunks]
        scores = model.predict(pairs)

        scored = list(zip(chunks, scores))
        scored.sort(key=lambda x: x[1], reverse=True)

        return [chunk for chunk, _ in scored[:top_k]]
