"""Vector retriever â€” queries the vector store."""

from typing import List, Dict, Optional
from app.core.rag.chunking import Chunk
from app.core.ai.embeddings import generate_embeddings
from app.vector_stores.factory import VectorStoreFactory
from app.config import get_settings


class VectorRetriever:
    def __init__(self):
        settings = get_settings()
        self.store = VectorStoreFactory.create(settings.VECTOR_STORE_TYPE)
        self.top_k = settings.TOP_K_RETRIEVAL

    async def retrieve(
        self,
        query: str,
        top_k: int | None = None,
        filters: Optional[Dict] = None,
    ) -> List[Chunk]:
        """Retrieve the most relevant chunks for a query."""
        embeddings = await generate_embeddings([query])
        query_vector = embeddings[0]

        results = await self.store.search(
            query_vector=query_vector,
            top_k=top_k or self.top_k,
            filters=filters,
        )

        return [
            Chunk(
                text=r["text"],
                index=r.get("index", 0),
                metadata=r.get("metadata", {}),
            )
            for r in results
        ]
