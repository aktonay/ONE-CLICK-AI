"""Web search abstraction â€” Tavily, Serper, DuckDuckGo."""

from typing import Dict, List
from app.config import get_settings
import logging

logger = logging.getLogger(__name__)


class WebSearchClient:
    """Low-level web search client. See SearchService for higher-level usage."""

    def __init__(self):
        self.settings = get_settings()
        self.provider = self.settings.SEARCH_PROVIDER

    async def search(self, query: str, max_results: int = 5) -> List[Dict]:
        if self.provider == "tavily":
            return await self._tavily(query, max_results)
        elif self.provider == "serper":
            return await self._serper(query, max_results)
        elif self.provider == "duckduckgo":
            return await self._duckduckgo(query, max_results)
        return await self._tavily(query, max_results)

    async def _tavily(self, query: str, max_results: int) -> List[Dict]:
        from tavily import AsyncTavilyClient

        client = AsyncTavilyClient(api_key=self.settings.TAVILY_API_KEY)
        response = await client.search(query, max_results=max_results)
        return [
            {"title": r.get("title", ""), "url": r.get("url", ""), "snippet": r.get("content", ""), "score": r.get("score", 0)}
            for r in response.get("results", [])
        ]

    async def _serper(self, query: str, max_results: int) -> List[Dict]:
        import httpx

        async with httpx.AsyncClient() as client:
            resp = await client.post(
                "https://google.serper.dev/search",
                json={"q": query, "num": max_results},
                headers={"X-API-KEY": self.settings.SERPER_API_KEY},
                timeout=15,
            )
            resp.raise_for_status()
            data = resp.json()
        return [
            {"title": r.get("title", ""), "url": r.get("link", ""), "snippet": r.get("snippet", ""), "score": 0}
            for r in data.get("organic", [])
        ]

    async def _duckduckgo(self, query: str, max_results: int) -> List[Dict]:
        from duckduckgo_search import DDGS

        results = []
        with DDGS() as ddgs:
            for r in ddgs.text(query, max_results=max_results):
                results.append({"title": r.get("title", ""), "url": r.get("href", ""), "snippet": r.get("body", ""), "score": 0})
        return results
