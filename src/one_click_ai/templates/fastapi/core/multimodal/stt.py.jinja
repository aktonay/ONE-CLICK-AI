"""Speech-to-Text abstraction layer."""

from typing import Dict
from app.config import get_settings
import logging

logger = logging.getLogger(__name__)


class STTClient:
    """Speech-to-Text client â€” delegates to the configured provider."""

    def __init__(self):
        self.settings = get_settings()
        self.provider = self.settings.STT_PROVIDER

    async def transcribe(self, audio_bytes: bytes, filename: str = "audio.wav") -> Dict:
        if self.provider == "openai":
            return await self._openai_stt(audio_bytes, filename)
        elif self.provider == "deepgram":
            return await self._deepgram_stt(audio_bytes)
        else:
            return await self._openai_stt(audio_bytes, filename)

    async def _openai_stt(self, audio_bytes: bytes, filename: str) -> Dict:
        import openai
        import io

        client = openai.AsyncOpenAI(api_key=self.settings.OPENAI_API_KEY)
        audio_file = io.BytesIO(audio_bytes)
        audio_file.name = filename

        result = await client.audio.transcriptions.create(
            model="whisper-1",
            file=audio_file,
            response_format="verbose_json",
        )
        return {"text": result.text, "language": getattr(result, "language", None)}

    async def _deepgram_stt(self, audio_bytes: bytes) -> Dict:
        try:
            from deepgram import DeepgramClient, PrerecordedOptions

            client = DeepgramClient(self.settings.DEEPGRAM_API_KEY)
            options = PrerecordedOptions(model="nova-2", language="en")
            response = await client.listen.asyncrest.v("1").transcribe_file(
                {"buffer": audio_bytes}, options
            )
            text = response.results.channels[0].alternatives[0].transcript
            return {"text": text, "language": "en"}
        except ImportError:
            logger.error("deepgram-sdk not installed")
            raise
